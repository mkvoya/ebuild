name: MacOS Build for GNU Emacs

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug session'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup dependencies directory
        run: |
          sudo mkdir -p /usr/local/deps
          sudo chmod 777 /usr/local/deps
          echo "DEPS_PREFIX=/usr/local/deps" >> $GITHUB_ENV
          echo "DEPS_BASE=/usr/local/deps" >> $GITHUB_ENV
          brew install m4
          brew install autoconf
          brew install automake
          brew install libtool
          brew install pkgconf
          brew install texinfo
      - name: Cache GNU Texinfo
        id: cache-texinfo
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/texinfo
          key: texinfo-7.2-${{ runner.os }}
      - name: Install GNU Texinfo
        if: steps.cache-texinfo.outputs.cache-hit != 'true'
        run: |
          curl -LO https://ftpmirror.gnu.org/gnu/texinfo/texinfo-7.2.tar.gz
          tar -zxf texinfo-7.2.tar.gz && cd texinfo-7.2
          ./configure --prefix=/usr/local/deps/texinfo && make -j4
          sudo make install
      - name: Save GNU Texinfo cache
        if: steps.cache-texinfo.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/texinfo
          key: texinfo-7.2-${{ runner.os }}
      - name: Setup GNU Texinfo environment
        run: echo "PATH=/usr/local/deps/texinfo/bin:$PATH" >> $GITHUB_ENV
      - name: Cache GNU Libiconv
        id: cache-libiconv
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/libiconv
          key: libiconv-1.18-${{ runner.os }}
      - name: Install GNU Libiconv
        if: steps.cache-libiconv.outputs.cache-hit != 'true'
        run: |
          curl -LO https://ftpmirror.gnu.org/gnu/libiconv/libiconv-1.18.tar.gz
          tar -zxf libiconv-1.18.tar.gz && cd libiconv-1.18
          ./configure --prefix=/usr/local/deps/libiconv --disable-shared && make -j4
          sudo make install
      - name: Save GNU Libiconv cache
        if: steps.cache-libiconv.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/libiconv
          key: libiconv-1.18-${{ runner.os }}
      - name: Setup GNU Libiconv environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/libiconv/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/libiconv/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/libiconv/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache GNU Libunistring
        id: cache-libunistring
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/libunistring
          key: libunistring-1.4.1-${{ runner.os }}
      - name: Install GNU Libunistring
        if: steps.cache-libunistring.outputs.cache-hit != 'true'
        run: |
          curl -LO https://ftpmirror.gnu.org/gnu/libunistring/libunistring-1.4.1.tar.gz
          tar -zxf libunistring-1.4.1.tar.gz && cd libunistring-1.4.1
          ./configure --prefix=/usr/local/deps/libunistring --disable-shared && make -j4
          sudo make install
      - name: Save GNU Libunistring cache
        if: steps.cache-libunistring.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/libunistring
          key: libunistring-1.4.1-${{ runner.os }}
      - name: Setup GNU Libunistring environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/libunistring/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/libunistring/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/libunistring/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache GNU Gettext
        id: cache-gettext
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/gettext
          key: gettext-0.26-${{ runner.os }}
      - name: Install GNU Gettext
        if: steps.cache-gettext.outputs.cache-hit != 'true'
        run: |
          curl -LO https://ftpmirror.gnu.org/gnu/gettext/gettext-0.26.tar.gz
          tar -zxf gettext-0.26.tar.gz && cd gettext-0.26
          ./configure --prefix=/usr/local/deps/gettext --disable-shared && make -j4
          sudo make install
      - name: Save GNU Gettext cache
        if: steps.cache-gettext.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/gettext
          key: gettext-0.26-${{ runner.os }}
      - name: Setup GNU Gettext environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/gettext/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/gettext/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/gettext/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache GNU Ncurses
        id: cache-ncurses
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/ncurses
          key: ncurses-6.5-${{ runner.os }}
      - name: Install GNU Ncurses
        if: steps.cache-ncurses.outputs.cache-hit != 'true'
        run: |
          curl -LO https://ftpmirror.gnu.org/gnu/ncurses/ncurses-6.5.tar.gz
          tar -zxf ncurses-6.5.tar.gz && cd ncurses-6.5
          ./configure --prefix=/usr/local/deps/ncurses --disable-shared && make -j4
          sudo make install
          sudo ln -s /usr/local/deps/ncurses/include/ncursesw/curses.h /usr/local/deps/ncurses/include/ncurses.h
      - name: Save GNU Ncurses cache
        if: steps.cache-ncurses.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/ncurses
          key: ncurses-6.5-${{ runner.os }}
      - name: Setup GNU Ncurses environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/ncurses/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/ncurses/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/ncurses/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache Zlib
        id: cache-zlib
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/zlib
          key: zlib-1.3.1-${{ runner.os }}
      - name: Install Zlib
        if: steps.cache-zlib.outputs.cache-hit != 'true'
        run: |
          curl -LO https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz
          tar -zxf zlib-1.3.1.tar.gz && cd zlib-1.3.1
          ./configure --prefix=/usr/local/deps/zlib --static && make -j4
          sudo make install
      - name: Save Zlib cache
        if: steps.cache-zlib.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/zlib
          key: zlib-1.3.1-${{ runner.os }}
      - name: Setup Zlib environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/zlib/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/zlib/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/zlib/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache Libxml2
        id: cache-libxml2
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/libxml2
          key: libxml2-2.15.1-${{ runner.os }}
      - name: Install Libxml2
        if: steps.cache-libxml2.outputs.cache-hit != 'true'
        run: |
          curl -LO https://download.gnome.org/sources/libxml2/2.15/libxml2-2.15.1.tar.xz
          tar -Jxf libxml2-2.15.1.tar.xz && cd libxml2-2.15.1
          ./configure --prefix=/usr/local/deps/libxml2 --disable-shared && make -j4
          sudo make install
      - name: Save Libxml2 cache
        if: steps.cache-libxml2.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/libxml2
          key: libxml2-2.15.1-${{ runner.os }}
      - name: Setup Libxml2 environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/libxml2/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/libxml2/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/libxml2/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache GNU Libgmp
        id: cache-gmp
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/gmp
          key: gmp-6.3.0-${{ runner.os }}
      - name: Install GNU Libgmp
        if: steps.cache-gmp.outputs.cache-hit != 'true'
        run: |
          curl -LO https://ftpmirror.gnu.org/gnu/gmp/gmp-6.3.0.tar.gz
          tar -zxf gmp-6.3.0.tar.gz && cd gmp-6.3.0
          ./configure --prefix=/usr/local/deps/gmp --disable-shared && make -j4
          sudo make install
      - name: Save GNU Libgmp cache
        if: steps.cache-gmp.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/gmp
          key: gmp-6.3.0-${{ runner.os }}
      - name: Setup GNU Libgmp environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/gmp/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/gmp/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/gmp/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache Libnettle
        id: cache-nettle
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/nettle
          key: nettle-3.10.2-${{ runner.os }}
      - name: Install Libnettle
        if: steps.cache-nettle.outputs.cache-hit != 'true'
        run: |
          curl -LO https://ftpmirror.gnu.org/gnu/nettle/nettle-3.10.2.tar.gz
          tar -zxf nettle-3.10.2.tar.gz && cd nettle-3.10.2
          ./configure --prefix=/usr/local/deps/nettle --disable-shared && make -j4
          sudo make install
      - name: Save Libnettle cache
        if: steps.cache-nettle.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/nettle
          key: nettle-3.10.2-${{ runner.os }}
      - name: Setup Libnettle environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/nettle/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/nettle/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/nettle/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache Libidn2
        id: cache-libidn2
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/libidn2
          key: libidn2-2.3.8-${{ runner.os }}
      - name: Install Libidn2
        if: steps.cache-libidn2.outputs.cache-hit != 'true'
        run: |
          curl -LO https://ftpmirror.gnu.org/gnu/libidn/libidn2-2.3.8.tar.gz
          tar -zxf libidn2-2.3.8.tar.gz && cd libidn2-2.3.8
          ./configure --prefix=/usr/local/deps/libidn2 --disable-shared && make -j4
          sudo make install
      - name: Save Libidn2 cache
        if: steps.cache-libidn2.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/libidn2
          key: libidn2-2.3.8-${{ runner.os }}
      - name: Setup Libidn2 environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/libidn2/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/libidn2/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/libidn2/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache GnuTLS
        id: cache-gnutls
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/gnutls
          key: gnutls-3.8.11-${{ runner.os }}
      - name: Install GnuTLS
        if: steps.cache-gnutls.outputs.cache-hit != 'true'
        run: |
          curl -O https://www.gnupg.org/ftp/gcrypt/gnutls/v3.8/gnutls-3.8.11.tar.xz
          tar -Jxf gnutls-3.8.11.tar.xz && cd gnutls-3.8.11
          ./configure --prefix=/usr/local/deps/gnutls --disable-shared --with-included-libtasn1 --without-p11-kit && make -j4
          sudo make install
      - name: Save GnuTLS cache
        if: steps.cache-gnutls.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/gnutls
          key: gnutls-3.8.11-${{ runner.os }}
      - name: Setup GnuTLS environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/gnutls/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/gnutls/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/gnutls/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache Libtreesitter
        id: cache-treesitter
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/treesitter
          key: treesitter-0.26.3-${{ runner.os }}
      - name: Install Libtreesitter
        if: steps.cache-treesitter.outputs.cache-hit != 'true'
        run: |
          curl -LO https://github.com/tree-sitter/tree-sitter/archive/refs/tags/v0.26.3.tar.gz
          tar -zxf v0.26.3.tar.gz && cd tree-sitter-0.26.3
          make PREFIX=/usr/local/deps/treesitter -j4
          sudo make PREFIX=/usr/local/deps/treesitter install
          sudo find /usr/local/deps/treesitter/lib -name 'libtree-sitter*.dylib' -delete
      - name: Save Libtreesitter cache
        if: steps.cache-treesitter.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/treesitter
          key: treesitter-0.26.3-${{ runner.os }}
      - name: Setup Libtreesitter environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/treesitter/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/treesitter/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/treesitter/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache GNU Gzip
        id: cache-gzip
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/gzip
          key: gzip-1.14-${{ runner.os }}
      - name: Install GNU Gzip
        if: steps.cache-gzip.outputs.cache-hit != 'true'
        run: |
          curl -LO https://ftpmirror.gnu.org/gnu/gzip/gzip-1.14.tar.gz
          tar -zxf gzip-1.14.tar.gz && cd gzip-1.14
          ./configure --prefix=/usr/local/deps/gzip && make -j4
          sudo make install
      - name: Save GNU Gzip cache
        if: steps.cache-gzip.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/gzip
          key: gzip-1.14-${{ runner.os }}
      - name: Setup GNU Gzip environment
        run: echo "PATH=/usr/local/deps/gzip/bin:$PATH" >> $GITHUB_ENV
      - name: Setup build environment
        run: |
          echo "PATH=/usr/local/bin:$PATH" >> $GITHUB_ENV
      - name: Cache libjpeg
        id: cache-libjpeg
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/libjpeg
          key: libjpeg-9f-${{ runner.os }}
      - name: Install libjpeg
        if: steps.cache-libjpeg.outputs.cache-hit != 'true'
        run: |
          curl -LO https://www.ijg.org/files/jpegsrc.v9f.tar.gz
          tar -zxf jpegsrc.v9f.tar.gz && cd jpeg-9f
          ./configure --prefix=/usr/local/deps/libjpeg --disable-shared && make -j4
          sudo make install
      - name: Save libjpeg cache
        if: steps.cache-libjpeg.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/libjpeg
          key: libjpeg-9f-${{ runner.os }}
      - name: Setup libjpeg environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/libjpeg/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/libjpeg/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/libjpeg/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache libtiff
        id: cache-libtiff
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/libtiff
          key: libtiff-4.7.1-${{ runner.os }}
      - name: Install libtiff
        if: steps.cache-libtiff.outputs.cache-hit != 'true'
        run: |
          curl -LO https://download.osgeo.org/libtiff/tiff-4.7.1.tar.gz
          tar -zxf tiff-4.7.1.tar.gz && cd tiff-4.7.1
          ./configure --prefix=/usr/local/deps/libtiff --disable-shared && make -j4
          sudo make install
      - name: Save libtiff cache
        if: steps.cache-libtiff.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/libtiff
          key: libtiff-4.7.1-${{ runner.os }}
      - name: Setup libtiff environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/libtiff/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/libtiff/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/libtiff/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache libgif
        id: cache-libgif
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/libgif
          key: libgif-5.2.2-${{ runner.os }}
      - name: Install libgif
        if: steps.cache-libgif.outputs.cache-hit != 'true'
        run: |
          curl -L https://sourceforge.net/projects/giflib/files/giflib-5.2.2.tar.gz/download -o giflib-5.2.2.tar.gz
          tar -zxf giflib-5.2.2.tar.gz && cd giflib-5.2.2
          make PREFIX=/usr/local/deps/libgif -j4
          sudo make PREFIX=/usr/local/deps/libgif install
          sudo find /usr/local/deps/libgif/lib -name 'libgif*.dylib' -delete
      - name: Save libgif cache
        if: steps.cache-libgif.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/libgif
          key: libgif-5.2.2-${{ runner.os }}
      - name: Setup libgif environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/libgif/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/libgif/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/libgif/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache libpng
        id: cache-libpng
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/libpng
          key: libpng-1.6.53-${{ runner.os }}
      - name: Install libpng
        if: steps.cache-libpng.outputs.cache-hit != 'true'
        run: |
          curl -L https://sourceforge.net/projects/libpng/files/libpng16/1.6.53/libpng-1.6.53.tar.gz/download -o libpng-1.6.53.tar.gz
          tar -zxf libpng-1.6.53.tar.gz && cd libpng-1.6.53
          ./configure --prefix=/usr/local/deps/libpng --disable-shared && make -j4
          sudo make install
      - name: Save libpng cache
        if: steps.cache-libpng.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/libpng
          key: libpng-1.6.53-${{ runner.os }}
      - name: Setup libpng environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/libpng/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/libpng/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/libpng/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Install librsvg
        run: brew install librsvg
      - name: Setup librsvg environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/librsvg/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/librsvg/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/librsvg/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache libwebp
        id: cache-libwebp
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/libwebp
          key: libwebp-1.6.0-${{ runner.os }}
      - name: Install libwebp
        if: steps.cache-libwebp.outputs.cache-hit != 'true'
        run: |
          curl -LO https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-1.6.0.tar.gz
          tar -zxf libwebp-1.6.0.tar.gz && cd libwebp-1.6.0
          ./configure --prefix=/usr/local/deps/libwebp --disable-shared && make -j4
          sudo make install
      - name: Save libwebp cache
        if: steps.cache-libwebp.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/libwebp
          key: libwebp-1.6.0-${{ runner.os }}
      - name: Setup libwebp environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/libwebp/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/libwebp/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/libwebp/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache SQLite3
        id: cache-sqlite3
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/sqlite3
          key: sqlite3-3.51.1-${{ runner.os }}
      - name: Install SQLite3
        if: steps.cache-sqlite3.outputs.cache-hit != 'true'
        run: |
          curl -LO https://sqlite.org/2025/sqlite-autoconf-3510100.tar.gz
          tar -zxf sqlite-autoconf-3510100.tar.gz && cd sqlite-autoconf-3510100
          ./configure --prefix=/usr/local/deps/sqlite3 --disable-shared && make -j4
          sudo make install
      - name: Save SQLite3 cache
        if: steps.cache-sqlite3.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/sqlite3
          key: sqlite3-3.51.1-${{ runner.os }}
      - name: Setup SQLite3 environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/sqlite3/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/sqlite3/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/sqlite3/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Cache lcms2
        id: cache-lcms2
        uses: actions/cache@v4
        with:
          path: /usr/local/deps/lcms2
          key: lcms2-2.17-${{ runner.os }}
      - name: Install lcms2
        if: steps.cache-lcms2.outputs.cache-hit != 'true'
        run: |
          curl -LO https://github.com/mm2/Little-CMS/releases/download/lcms2.17/lcms2-2.17.tar.gz
          tar -zxf lcms2-2.17.tar.gz && cd lcms2-2.17
          ./configure --prefix=/usr/local/deps/lcms2 --disable-shared && make -j4
          sudo make install
      - name: Save lcms2 cache
        if: steps.cache-lcms2.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: /usr/local/deps/lcms2
          key: lcms2-2.17-${{ runner.os }}
      - name: Setup lcms2 environment
        run: |
          echo "PKG_CONFIG_PATH=/usr/local/deps/lcms2/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "CPPFLAGS=-I/usr/local/deps/lcms2/include $CPPFLAGS" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/local/deps/lcms2/lib $LDFLAGS" >> $GITHUB_ENV
      - name: Setup upterm session
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.debug == 'true'
        uses: owenthereal/action-upterm@v1
      - name: Build Emacs
        run: |
          git clone --depth 1 https://github.com/emacs-mirror/emacs.git
          cd emacs && sed -i '' '/darwin/ s/lncurses/lncursesw/g' configure.ac
          patch -p1 < ../patches/system-appearance.patch
          patch -p1 < ../patches/ksqsf-smooth-cursor.patch
          patch -p1 < ../patches/round-undecorated-frame.patch
          ./autogen.sh && ./configure CFLAGS='-O2 -g0 -flto=thin'   \
                                      PKG_CONFIG='pkgconf -static'  \
                                      PKG_CONFIG_PATH="$PKG_CONFIG_PATH" \
                                      CPPFLAGS="$CPPFLAGS"          \
                                      LDFLAGS="$LDFLAGS"             \
                                      --disable-gc-mark-trace       \
                                      --without-all                 \
                                      --with-compress-install       \
                                      --with-gif                    \
                                      --with-gmp                    \
                                      --with-gnutls                 \
                                      --with-imagemagick            \
                                      --with-jpeg                   \
                                      --with-lcms2                  \
                                      --with-modules                \
                                      --with-native-image-api       \
                                      --with-ns                     \
                                      --with-png                    \
                                      --with-rsvg                   \
                                      --with-small-ja-dic           \
                                      --with-sqlite3                \
                                      --with-threads                \
                                      --with-tiff                   \
                                      --with-toolkit-scroll-bars    \
                                      --with-tree-sitter            \
                                      --with-webp                   \
                                      --with-xml2                   \
                                      --with-zlib
          make -j4 && make install
          ditto nextstep/Emacs.app Emacs.app
          echo version=$(Emacs.app/Contents/MacOS/Emacs --version | sed -nE 's/^GNU Emacs ([0-9.]+).*/\1/p') >> $GITHUB_ENV
          tar -Jcf Emacs.tar.xz Emacs.app
      - name: Build Emacs with MPS
        run: |
          git clone -b 'feature/igc' --depth 1 https://github.com/emacs-mirror/emacs.git emacs-igc
          cd emacs-igc && sed -i '' '/darwin/ s/lncurses/lncursesw/g' configure.ac
          ./autogen.sh && ./configure CFLAGS='-O2 -g0 -flto=thin'   \
                                      PKG_CONFIG='pkgconf -static'  \
                                      PKG_CONFIG_PATH="$PKG_CONFIG_PATH" \
                                      CPPFLAGS="$CPPFLAGS"          \
                                      LDFLAGS="$LDFLAGS"             \
                                      --disable-gc-mark-trace       \
                                      --without-all                 \
                                      --with-compress-install       \
                                      --with-gif                    \
                                      --with-gmp                    \
                                      --with-gnutls                 \
                                      --with-imagemagick            \
                                      --with-jpeg                   \
                                      --with-lcms2                  \
                                      --with-modules                \
                                      --with-mps                    \
                                      --with-native-image-api       \
                                      --with-ns                     \
                                      --with-png                    \
                                      --with-rsvg                   \
                                      --with-small-ja-dic           \
                                      --with-sqlite3                \
                                      --with-threads                \
                                      --with-tiff                   \
                                      --with-toolkit-scroll-bars    \
                                      --with-tree-sitter            \
                                      --with-webp                   \
                                      --with-xml2                   \
                                      --with-zlib
          make -j4 && make install
          ditto nextstep/Emacs.app Emacs.app
          echo igc_version=$(Emacs.app/Contents/MacOS/Emacs --version | sed -nE 's/^GNU Emacs ([0-9.]+).*/\1/p') >> $GITHUB_ENV
          tar -Jcf Emacs-MPS.tar.xz Emacs.app
      - name: Upload Emacs
        uses: actions/upload-artifact@v4
        with:
          name: Emacs-${{ env.version }}
          path: emacs/Emacs.tar.xz
      - name: Upload Emacs with MPS
        uses: actions/upload-artifact@v4
        with:
          name: Emacs-MPS-${{ env.igc_version }}
          path: emacs-igc/Emacs-MPS.tar.xz
